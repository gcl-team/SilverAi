name: SilverAi CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Install Python
    - name: Set up Python 3.14
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"

    # 3. Install Poetry (The Manager)
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true

    # 4. Install Dependencies (Reads pyproject.toml)
    - name: Install dependencies
      run: poetry install --no-interaction --no-root

    # 5. Check for ghost dependencies
    - name: Check for Ghost Dependencies
      run: |
        pip install deptry
        deptry .

    # 6. Install the library itself
    - name: Install library
      run: poetry install --no-interaction

    # 7. Run Security & Linting (Ruff)
    - name: Run Linting & Security (Ruff)
      run: poetry run ruff check .

    # 8. Run Tests
    - name: Run Tests
      run: poetry run pytest

    # 9. Check the library size
    - name: Build and Check Size
      run: |
        poetry build
        echo "Checking package size..."
        
        # Get size in KB
        SIZE_KB=$(du -k dist/*.whl | cut -f1)
        echo "Size: ${SIZE_KB} KB"
        
        # Fail if > 20KB
        if [ "$SIZE_KB" -gt 20 ]; then
          echo "❌ ERROR: SilverAI is too fat! (${SIZE_KB}KB > 20KB)"
          exit 1
        else
          echo "✅ Optimization Pass: Library is lean."
        fi

    # 10. Check the total size with dependencies
    - name: Check Total Install Size
      run: |
        # Calculate size of site-packages (where libs live)
        TOTAL_SIZE=$(du -sh $(poetry env info --path)/lib | cut -f1)
        echo "Total Weight (Library + Dependencies): $TOTAL_SIZE"

        # Fail if > 50KB
        if [ "$TOTAL_SIZE" -gt 50 ]; then
          echo "❌ ERROR: SilverAI is too fat! (${TOTAL_SIZE}KB > 50KB)"
          exit 1
        else
          echo "✅ Optimization Pass: Library is lean."
        fi
