name: SilverAi CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Install Python
    - name: Set up Python 3.14
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"

    # 3. Install Poetry (The Manager)
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true

    # 4. Install Dependencies (Reads pyproject.toml)
    - name: Install dependencies
      run: poetry install --no-interaction --no-root

    # 5. Check for ghost dependencies
    - name: Check for Ghost Dependencies
      run: |
        pip install deptry
        deptry .

    # 6. Install the library itself
    - name: Install library
      run: poetry install --no-interaction

    # 7. Run Security & Linting (Ruff)
    - name: Run Linting & Security (Ruff)
      run: poetry run ruff check .

    # 8. Run Tests
    - name: Run Tests
      run: poetry run pytest

    # 9. Check the library size
    - name: Build and Check Size
      run: |
        poetry build
        echo "Checking package size..."
        
        # Get size in KB
        LIB_SIZE_KB=$(du -sk dist/*.whl | cut -f1)
        echo "Size: ${LIB_SIZE_KB}KB"
        
        # Fail if > 20KB
        if [ "$LIB_SIZE_KB" -gt 20 ]; then
          echo "âŒ ERROR: SilverAi is too fat! (${LIB_SIZE_KB}KB > 20KB)"
          exit 1
        else
          echo "âœ… Optimization Pass: Library is lean."
        fi

    # 10. Check the total size with dependencies
    - name: Check Total Install Size
      run: |
        echo "ðŸ§ª Creating a fresh environment..."
        python -m venv .simulated_env
        source .simulated_env/bin/activate
        
        # 1. Install the wheel
        pip install dist/*.whl
        
        # 2. Locate site-packages
        SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
        
        # 3. Measure ONLY the 'silver_ai' folder
        # This ignores 'pip' and 'setuptools' overhead
        LIB_SIZE_KB=$(du -sk $SITE_PACKAGES/silver_ai | cut -f1)
        
        echo "ðŸ“¦ SilverAi Installed Size: ${LIB_SIZE_KB}KB"

        # 4. Fail if > 100KB
        if [ "$LIB_SIZE_KB" -gt 100 ]; then
          echo "âŒ ERROR: SilverAi is too fat! (${LIB_SIZE_KB}KB > 20KB)"
          exit 1
        else
          echo "âœ… Optimization Pass: Library is lean."
        fi
